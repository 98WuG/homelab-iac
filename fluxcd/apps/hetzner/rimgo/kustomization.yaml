---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: rimgo
resources:
- namespace.yaml
- ../../base/app-template
namePrefix: rimgo-
patches:
- target:
    kind: HelmRelease
    name: app-template
  patch: |-
    apiVersion: apps/v1
    kind: HelmRelease
    metadata:
      name: app-template
    spec:
      values:
        image:
          repository: codeberg.org/video-prize-ranch/rimgo
          tag: latest
        controller:
          annotations:
            keel.sh/policy: force
            keel.sh/trigger: poll
            keel.sh/match-tag: "true"
            keel.sh/pollSchedule: "@every 60m"
          replicas: 1
          strategy: RollingUpdate
        service:
          main:
            ports:
              http:
                port: 3000
        ingress:
          main:
            enabled: true
            annotations:
              homelab/public: "true"
              cert-manager.io/cluster-issuer: letsencrypt
              external-dns.alpha.kubernetes.io/hostname: rimgo.${DOMAIN}
              external-dns.alpha.kubernetes.io/target: hetzner.${DOMAIN}
            hosts:
            - host: rimgo.${DOMAIN}
              paths:
              - path: /
                pathType: Prefix
            tls:
            - hosts:
              - rimgo.${DOMAIN}
              secretName: rimgo-cert
