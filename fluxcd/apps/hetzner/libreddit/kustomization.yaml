---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: libreddit
resources:
- namespace.yaml
- ../../base/app-template
namePrefix: libreddit-
patches:
- target:
    kind: HelmRelease
    name: app-template
  patch: |-
    apiVersion: apps/v1
    kind: HelmRelease
    metadata:
      name: app-template
    spec:
      values:
        image:
          repository: docker.io/spikecodes/libreddit
          tag: latest
        controller:
          annotations:
            keel.sh/policy: force
            keel.sh/trigger: poll
            keel.sh/match-tag: "true"
            keel.sh/pollSchedule: "@every 60m"
          replicas: 3
          strategy: RollingUpdate
          rollingUpdate:
            surge: 1
            unavailable: 1
        service:
          main:
            ports:
              http:
                port: 8080
        ingress:
          main:
            enabled: true
            annotations:
              homelab/public: "true"
              cert-manager.io/cluster-issuer: letsencrypt
              external-dns.alpha.kubernetes.io/hostname: libreddit.${DOMAIN}
              external-dns.alpha.kubernetes.io/target: hetzner.${DOMAIN}
            hosts:
            - host: libreddit.${DOMAIN}
              paths:
              - path: /
                pathType: Prefix
            tls:
            - hosts:
              - libreddit.${DOMAIN}
              secretName: libreddit-cert

