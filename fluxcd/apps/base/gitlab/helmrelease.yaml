---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: gitlab
  namespace: gitlab
spec:
  chart:
    spec:
      chart: gitlab
      sourceRef:
        kind: HelmRepository
        name: gitlab
        namespace: flux-system
  interval: 10m0s
  timeout: 15m0s
  values:
    global:
      edition: ee
      ingress:
        configureCertmanager: false
        class: nginx-public
        annotations:
          homelab/public: "true"
          external-dns.alpha.kubernetes.io/hostname: gitlab.${DOMAIN},registry.${DOMAIN}
          external-dns.alpha.kubernetes.io/target: ${DOMAIN}
        tls:
          secretName: ${LETSENCRYPT_CERT}
      hosts:
        domain: "${DOMAIN}"
      appConfig:
        enableUsagePing: false
        omniauth:
          enabled: true
          allowSingleSignOn:
          - saml
          syncProfileFromProvider:
          - saml
          syncProfileAttributes:
          - email
          autoSignInWithProvider: saml
          blockAutoCreatedUsers: false
          autoLinkSamlUser: true
          providers:
          - secret: gitlab-secret
            key: provider
        initialDefaults:
          signupEnabled: false
      smtp:
        enabled: true
        address: smtp.sendgrid.net
        port: 587
        user_name: apikey
        password:
          secret: gitlab-secret
          key: SMTP_KEY
        domain: smtp.sendgrid.net
        authentication: plain
        starttls_auto: true
        tls: false
      email:
        from: gitlab@no-reply.${DOMAIN}
        reply_to: noreply@no-reply.${DOMAIN}
    nginx-ingress:
      enabled: false
    certmanager:
      install: false
    gitlab-runner:
      runners:
        config: |
          [[runners]]
            executors = "kubernetes"
            environment = [ "container=kube" ]
            [runners.kubernetes]
            image = "ubuntu:18.04"
            {{- if .Values.global.minio.enabled }}
            [runners.cache]
              Type = "s3"
              Path = "gitlab-runner"
              Shared = true
              [runners.cache.s3]
                ServerAddress = {{ include "gitlab-runner.cache-tpl.s3ServerAddress" . }}
                BucketName = "runner-cache"
                BucketLocation = "us-east-1"
                Insecure = false
            {{ end }}
      podAnnotations:
        backup.velero.io/backup-volumes-excludes: runner-secrets
    postgresql:
      install: true
    redis:
      install: true
      cluster:
        enabled: true
    minio:
      persistence:
        enabled: true
        annotations: 
          helm.sh/resource-policy: keep
    gitlab:
      webservice:
        enabled: true
        workerProcesses: 2
        resources:
          requests:
            memory: 1Gi
          limits:
            memory: 3Gi
      sidekiq:
        enabled: true
        resources:
          requests:
            memory: 1Gi
          limits:
            memory: 3Gi
