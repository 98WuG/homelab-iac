---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: hydrogen-web
  namespace: synapse
spec:
  chart:
    spec:
      chart: app-template
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
  interval: 10m0s
  timeout: 10m0s
  values:
    controller:
      replicas: 3
      strategy: RollingUpdate
    image:
      repository: ghcr.io/vector-im/hydrogen-web
      tag: v0.3.4
    resources:
      requests:
        cpu: 25m
    service:
      main:
        ports:
          http:
            port: 80
    ingress:
      main:
        enabled: true
        ingressClassName: nginx-public
        annotations:
          homelab/public: "true"
          external-dns.alpha.kubernetes.io/hostname: hydrogen.${DOMAIN}
          external-dns.alpha.kubernetes.io/target: ${DOMAIN}
        hosts:
        - host: hydrogen.${DOMAIN}
          paths:
          - path: /
            pathType: Prefix
    persistence:
      config:
        enabled: true
        type: custom
        volumeSpec:
          configMap:
            name: hydrogen-web-config
        subPath:
        - path: config.json
          mountPath: /usr/share/nginx/html/config.json
    configmap:
      config:
        enabled: true
        data:
          config.json: |-
            {
              "push": {
                "appId": "io.element.hydrogen.web",
                "gatewayUrl": "https://matrix.org",
                "applicationServerKey": "BC-gpSdVHEXhvHSHS0AzzWrQoukv2BE7KzpoPO_FfPacqOo3l1pdqz7rSgmB04pZCWaHPz7XRe6fjLaC-WPDopM"
              },
              "defaultHomeServer": "${DOMAIN}",
              "bugReportEndpointUrl": "https://element.io/bugreports/submit",
              "themeManifests": [
                "assets/theme-element.json"
              ],
              "defaultTheme": {
                "light": "element-light",
                "dark": "element-dark"
              }
            }
