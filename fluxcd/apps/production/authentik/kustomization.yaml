---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
- keydb
- ../../base/authentik
patches:
- target:
    kind: HelmRelease
    name: authentik
  patch: |-
    apiVersion: helm.toolkit.fluxcd.io/v2beta1
    kind: HelmRelease
    metadata:
      name: authentik
      namespace: authentik
    spec:
      values:
        replicas: 3
        worker:
          replicas: 3
        authentik:
          redis:
            host: authentik-keydb-headless
        envFrom:
          AUTHENTIK_REDIS__PASSWORD:
            secretKeyRef:
              key: password
              name: authentik-keydb-secret
        redis:
          enabled: false
