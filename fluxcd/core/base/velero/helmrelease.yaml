---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: velero
  namespace: velero
spec:
  chart:
    spec:
      chart: velero
      version: "5.2.2"
      sourceRef:
        kind: HelmRepository
        name: vmware-tanzu
        namespace: flux-system
  interval: 10m0s
  values:
    image:
      repository: velero/velero
      tag: v1.12.3
      pullPolicy: IfNotPresent
    initContainers:
    - name: velero-plugin-for-aws
      image: velero/velero-plugin-for-aws:v1.9.0
      imagePullPolicy: IfNotPresent
      volumeMounts:
      - mountPath: /target
        name: plugins
    - name: velero-plugin-for-csi
      image: velero/velero-plugin-for-csi:v0.6.3
      imagePullPolicy: IfNotPresent
      volumeMounts:
      - mountPath: /target
        name: plugins
    metrics:
      enabled: true
      serviceMonitor:
        enabled: false
        additionalLabels:
          release: prometheus
        namespace: prometheus
    upgradeCRDs: true
    cleanUpCRDs: false
    resources:
      requests:
        cpu: 125m
        memory: 128Mi
      limits:
        cpu: 1000m
        memory: 512Mi
    configuration:
      backupStorageLocation:
      - name: velero-onprem
        provider: aws
        bucket: velero
        default: true
        accessMode: ReadWrite # change to ReadOnly during migrations/restores
        credential:
          name: velero-onprem
          key: cloud
        config:
          region: default
          s3ForcePathStyle: "true"
          s3Url: "${S3_URL}"
      - name: velero-b2
        provider: aws
        bucket: velero
        default: false
        validationFrequency: 120m
        accessMode: ReadWrite
        credential:
          name: velero-b2
          key: cloud
        config:
          region: us-west-004
          s3ForcePathStyle: "true"
          s3Url: "${S3_B2_URL}"
      volumeSnapshotLocation:
      - name: velero-onprem
        provider: csi
      uploaderType: restic
      backupSyncPeriod: 240m
      restoreOnlyMode: false
      defaultVolumesToFsBackup: true
    rbac:
      create: true
      clusterAdministrator: true
    credentials:
      useSecret: true
      name: velero-onprem
      existingSecret: velero-onprem
      secretContents: {}
    backupsEnabled: true
    snapshotsEnabled: false
    deployNodeAgent: true
    nodeAgent:
      resources:
        requests:
          cpu: 125m
          memory: 128Mi
        limits:
          cpu: 1000m
          memory: 1024Mi
    schedules:
      onprem: &schedule
        disabled: false
        schedule: 12 */6 * * *
        useOwnershipReferencesInBackup: false
        template: &template
          resourcePolicy:
            kind: configmap
            name: resource-policy
          ttl: 168h
          includedNamespaces:
          - authentik
          - cert-manager
          - gitlab
          - gotify
          - immich
          - media
          - nextcloud
          - privatebin
          - send
          - shynet
          - synapse
          - vaultwarden
          - wiki
          excludedResources:
          - orders.acme.cert-manager.io
          - challenges.acme.cert-manager.io
          - certificaterequests.cert-manager.io 
          snapshotVolumes: false
          storageLocation: velero-onprem
          snapshotMoveData: false
          datamover: velero
      b2:
        <<: *schedule
        schedule: 52 13 * * *
        template:
          <<: *template
          ttl: 336h
          storageLocation: velero-b2
